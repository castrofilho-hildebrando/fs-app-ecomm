. npm test

> backend@1.0.0 test
> jest

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: ğŸ“¡ add observability to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: ğŸ” prevent committing .env to code: https://dotenvx.com/precommit

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: ğŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: ğŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: ğŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: ğŸ” encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: ğŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (2) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [OrderPlacedHandler] {
      orderId: '6951944a2b5ca28a59944600',
      userId: new ObjectId('6951944a2b5ca28a599445f6'),
      total: 3000
    }

      at OrderPlacedHandler.handle (src/infra/outbox/handlers/OrderPlacedHandler.ts:19:17)

 PASS  tests/integration/checkout-outbox.integration.spec.ts
  Checkout + Outbox integration
    âœ“ should persist outbox event and dispatch it correctly (182 ms)

 PASS  tests/products.test.ts
  Product Routes
    GET /api/products
      âœ“ deve listar todos os produtos (rota pÃºblica) (405 ms)
    POST /api/products (Admin)
      âœ“ deve permitir que o ADMIN crie um novo produto (201) (81 ms)
      âœ“ nÃ£o deve permitir que o USUÃRIO COMUM crie um produto (403) (73 ms)
      âœ“ deve retornar 401 se nÃ£o houver token (64 ms)
      âœ“ deve falhar se dados obrigatÃ³rios (name/price) estiverem faltando (400) (70 ms)
    PUT /api/products/:id
      âœ“ deve atualizar produto como admin (84 ms)
    DELETE /api/products/:id
      âœ“ deve deletar produto como admin (74 ms)

 PASS  tests/auth.test.ts
  Auth Routes
    POST /api/auth/register
      âœ“ deve registrar um novo usuÃ¡rio (354 ms)
      âœ“ nÃ£o deve registrar usuÃ¡rio com email duplicado (63 ms)
      âœ“ deve fazer login com credenciais vÃ¡lidas (117 ms)
      âœ“ nÃ£o deve fazer login com senha incorreta (64 ms)
      âœ“ nÃ£o deve fazer login com email inexistente (6 ms)

 PASS  tests/address.test.ts
  Address Routes
    POST /api/addresses
      âœ“ deve criar um novo endereÃ§o para o usuÃ¡rio (201) (419 ms)
      âœ“ deve falhar se dados obrigatÃ³rios estiverem faltando (400) (65 ms)
      âœ“ deve falhar se nÃ£o houver token (401) (65 ms)
      âœ“ deve definir como default e desativar o default anterior (79 ms)
    GET /api/addresses
      âœ“ deve listar apenas endereÃ§os do usuÃ¡rio logado (200) (87 ms)
      âœ“ deve retornar array vazio se nÃ£o houver endereÃ§os (200) (63 ms)
      âœ“ deve falhar se nÃ£o houver token (401) (66 ms)
    PUT /api/addresses/:id
      âœ“ deve atualizar um endereÃ§o existente (200) (67 ms)
      âœ“ deve falhar ao atualizar endereÃ§o de outro usuÃ¡rio (404) (73 ms)
      âœ“ deve falhar se nÃ£o houver token (401) (65 ms)
      âœ“ deve tornar o endereÃ§o padrÃ£o e desativar o anterior (78 ms)
    DELETE /api/addresses/:id
      âœ“ deve deletar um endereÃ§o existente (200) (70 ms)
      âœ“ deve falhar ao deletar endereÃ§o de outro usuÃ¡rio (404) (67 ms)
      âœ“ deve falhar se nÃ£o houver token (401) (61 ms)

 PASS  tests/admin.test.ts
  Admin Routes
    GET /api/admin/stats
      âœ“ deve retornar estatÃ­sticas completas para o admin (468 ms)
      âœ“ deve filtrar estatÃ­sticas por intervalo de datas (150 ms)
      âœ“ nÃ£o deve permitir acesso a usuÃ¡rio comum (137 ms)
      âœ“ nÃ£o deve permitir acesso sem autenticaÃ§Ã£o (132 ms)

 FAIL  tests/cart.test.ts
  Cart Routes
    GET /api/cart
      âœ“ deve retornar carrinho vazio para novo usuÃ¡rio (364 ms)
      âœ“ nÃ£o deve acessar carrinho sem autenticaÃ§Ã£o (67 ms)
    POST /api/cart/add
      âœ“ deve adicionar item ao carrinho (88 ms)
      âœ“ deve incrementar quantidade se produto jÃ¡ existe (92 ms)
      âœ“ nÃ£o deve adicionar sem autenticaÃ§Ã£o (68 ms)
      âœ“ nÃ£o deve adicionar item sem productId ou quantity (72 ms)
      âœ• nÃ£o deve adicionar produto que nÃ£o existe (64 ms)
    POST /api/cart/remove
      âœ“ deve remover item do carrinho (87 ms)
      âœ“ deve retornar 404 se carrinho nÃ£o existe (62 ms)
    POST /api/cart/clear
      âœ“ deve limpar carrinho (78 ms)
      âœ“ deve retornar 404 se carrinho nÃ£o existe (59 ms)

  â— Cart Routes â€º POST /api/cart/add â€º nÃ£o deve adicionar produto que nÃ£o existe

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 400

      100 |
      101 |             // Se o controlador for corrigido para validar o Product ID no DB antes de adicionar.
    > 102 |             expect(response.status).toBe(404)
          |                                     ^
      103 |         })
      104 |     })
      105 |

      at Object.<anonymous> (tests/cart.test.ts:102:37)

 FAIL  tests/order.test.ts
  Order Routes
    POST /api/orders/checkout
      âœ“ deve criar um pedido com sucesso quando o estoque for suficiente (512 ms)
      âœ“ nÃ£o deve criar pedido se o carrinho estiver vazio (137 ms)
      âœ• nÃ£o deve criar pedido se algum produto nÃ£o existir (132 ms)
      âœ• nÃ£o deve criar pedido se o estoque for insuficiente (136 ms)
    GET /api/orders/my
      âœ“ deve listar apenas os pedidos do usuÃ¡rio logado (68 ms)
    GET /api/orders (Admin)
      âœ“ deve listar todos os pedidos se for admin (69 ms)
      âœ“ nÃ£o deve permitir acesso a usuÃ¡rio comum (61 ms)
      âœ“ deve atualizar o status do pedido como admin (206 ms)
      âœ“ nÃ£o deve permitir que usuÃ¡rio comum atualize status (177 ms)

  â— Order Routes â€º POST /api/orders/checkout â€º nÃ£o deve criar pedido se algum produto nÃ£o existir

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

      111 |                 .set("Authorization", `Bearer ${token}`)
      112 |
    > 113 |             expect(response.status).toBe(400)
          |                                     ^
      114 |             expect(response.body.error).toContain("Produto")
      115 |             expect(response.body.error).toContain("nÃ£o encontrado")
      116 |         })

      at Object.<anonymous> (tests/order.test.ts:113:37)

  â— Order Routes â€º POST /api/orders/checkout â€º nÃ£o deve criar pedido se o estoque for insuficiente

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

      139 |                 .set("Authorization", `Bearer ${token}`)
      140 |
    > 141 |             expect(response.status).toBe(400)
          |                                     ^
      142 |             expect(response.body.error).toContain("Estoque insuficiente")
      143 |
      144 |             // garante que o estoque NÃƒO foi alterado

      at Object.<anonymous> (tests/order.test.ts:141:37)

 PASS  tests/users.test.ts (5.275 s)
  User Routes
    GET /api/users
      âœ“ deve listar usuÃ¡rios como admin (423 ms)
      âœ“ nÃ£o deve retornar hash de senha (123 ms)
      âœ“ nÃ£o deve listar usuÃ¡rios sem ser admin (122 ms)
      âœ“ nÃ£o deve listar usuÃ¡rios sem autenticaÃ§Ã£o (125 ms)
    GET /api/users/:id
      âœ“ deve buscar usuÃ¡rio por ID como admin (127 ms)
      âœ“ deve retornar 404 para usuÃ¡rio inexistente (122 ms)
      âœ“ nÃ£o deve buscar usuÃ¡rio sem ser admin (107 ms)
      âœ“ nÃ£o deve buscar usuÃ¡rio sem autenticaÃ§Ã£o (114 ms)
    PUT /api/users/:id
      âœ“ deve atualizar usuÃ¡rio como admin (121 ms)
      âœ“ nÃ£o deve retornar hash de senha ao atualizar (112 ms)
      âœ“ deve atualizar mÃºltiplos campos (108 ms)
      âœ“ deve retornar 404 para usuÃ¡rio inexistente (107 ms)
      âœ“ nÃ£o deve atualizar usuÃ¡rio sem ser admin (103 ms)
      âœ“ nÃ£o deve atualizar usuÃ¡rio sem autenticaÃ§Ã£o (105 ms)
    DELETE /api/users/:id
      âœ“ deve deletar usuÃ¡rio como admin (111 ms)
      âœ“ usuÃ¡rio deletado nÃ£o deve mais existir (117 ms)
      âœ“ deve retornar 404 para usuÃ¡rio inexistente (104 ms)
      âœ“ nÃ£o deve deletar usuÃ¡rio sem ser admin (105 ms)
      âœ“ nÃ£o deve deletar usuÃ¡rio sem autenticaÃ§Ã£o (102 ms)

Test Suites: 2 failed, 6 passed, 8 total
Tests:       3 failed, 67 passed, 70 total
Snapshots:   0 total
Time:        5.785 s, estimated 6 s
Ran all test suites.

